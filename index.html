<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Countdown</title>
  <style>
    :root{
      --border:#e5e7eb; --text:#111827; --muted:#6b7280; --ok:#111827; --warn:#b45309; --danger:#dc2626; --bg:#ffffff;
    }
    @media (prefers-color-scheme: dark){
      :root{ --border:#374151; --text:#f3f4f6; --muted:#9ca3af; --ok:#f3f4f6; --warn:#f59e0b; --danger:#f87171; --bg:#111827; }
    }
    html,body{margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, "Segoe UI", Arial;}
    .card{max-width:560px; margin:24px auto; padding:16px; border:1px solid var(--border); border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,.06);}
    .row{display:flex; align-items:center; justify-content:space-between; gap:12px;}
    .title{font-size:13px; color:var(--muted); margin-bottom:2px}
    .time{font-size:44px; font-weight:800; letter-spacing:.5px}
    .status{font-size:12px; color:var(--muted); margin-top:4px}
    .btn{padding:8px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer}
    @media (prefers-color-scheme: dark){ .btn{ background:#111827; } }
    .bar{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden; margin-top:12px; border:1px solid var(--border)}
    .bar>div{height:100%; width:0%}
  </style>
</head>
<body>
  <div class="card">
    <div class="row">
      <div>
        <div id="label" class="title">Countdown</div>
        <div id="display" class="time">10:00</div>
        <div id="status" class="status">Running</div>
      </div>
      <div style="display:flex; gap:8px">
        <button id="restart" class="btn">Restart</button>
      </div>
    </div>
    <div class="bar" aria-hidden="true"><div id="barfill"></div></div>
  </div>

  <script>
  (function () {
    // --------- Config via URL params ----------
    // ?m=10   -> minutes (default 10)
    // ?s=600  -> OR total seconds (overrides minutes if present)
    // ?label=Break%20Timer
    // ?warn=1 -> minutes left to switch to warning colour (default 1)
    // ?beep=1 -> play a short beep at end (default 1)
    const params = new URLSearchParams(location.search);
    const m = parseInt(params.get('m') || '10', 10);
    const sOverride = parseInt(params.get('s') || '0', 10);
    const totalSeconds = Number.isFinite(sOverride) && sOverride > 0 ? sOverride : m * 60;
    const label = params.get('label') || 'Countdown';
    const warnAtMin = Math.max(0, parseInt(params.get('warn') || '1', 10));
    const doBeep = (params.get('beep') ?? '1') !== '0';

    // Elements
    const displayEl = document.getElementById('display');
    const statusEl  = document.getElementById('status');
    const labelEl   = document.getElementById('label');
    const btnRestart= document.getElementById('restart');
    const barFill   = document.getElementById('barfill');

    // Styles for bar colours
    const colours = {
      ok:    getComputedStyle(document.documentElement).getPropertyValue('--ok').trim(),
      warn:  getComputedStyle(document.documentElement).getPropertyValue('--warn').trim(),
      danger:getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()
    };

    let endTs, timerId, done = false, startedAt;

    function pad(n){ return String(n).padStart(2,'0'); }
    function fmt(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec / 60), s = sec % 60;
      return `${pad(m)}:${pad(s)}`;
    }

    function start() {
      startedAt = Date.now();
      endTs = startedAt + totalSeconds * 1000;
      done = false;
      statusEl.textContent = 'Running';
      displayEl.style.color = '';
      tick(); // paint immediately
      if (timerId) clearInterval(timerId);
      timerId = setInterval(tick, 250);
    }

    function beep(){
      if (!doBeep) return;
      try{
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(880, ctx.currentTime);
        gain.gain.setValueAtTime(0.001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
        osc.connect(gain); gain.connect(ctx.destination);
        osc.start(); osc.stop(ctx.currentTime + 0.4);
      }catch(e){}
    }

    function tick(){
      const now = Date.now();
      let remainingMs = endTs - now;
      if (remainingMs <= 0){
        if (!done){
          done = true;
          displayEl.textContent = '00:00';
          statusEl.textContent = 'Completed';
          displayEl.style.color = colours.danger;
          barFill.style.width = '100%';
          barFill.style.background = colours.danger;
          clearInterval(timerId);
          beep();
        }
        return;
      }
      const remainingSec = remainingMs / 1000;
      displayEl.textContent = fmt(remainingSec);

      // Progress bar (increasing fill as time elapses)
      const elapsed = totalSeconds - remainingSec;
      const pct = Math.min(100, Math.max(0, (elapsed / totalSeconds) * 100));
      barFill.style.width = pct.toFixed(2) + '%';

      // Colour phases
      const remMin = remainingSec / 60;
      if (remMin <= 0.1){ // last ~6 seconds -> danger
        displayEl.style.color = colours.danger;
        barFill.style.background = colours.danger;
      } else if (remMin <= warnAtMin){
        displayEl.style.color = colours.warn;
        barFill.style.background = colours.warn;
      } else {
        displayEl.style.color = colours.ok;
        barFill.style.background = colours.ok;
      }
    }

    // UI wiring
    btnRestart.addEventListener('click', start);
    labelEl.textContent = label;

    // Auto-start
    start();

    // Clean up
    window.addEventListener('beforeunload', () => { if (timerId) clearInterval(timerId); });
  })();
  </script>
</body>
</html>
